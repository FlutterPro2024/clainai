<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<!-- PWA Meta Tags -->
<meta name="theme-color" content="#3B82F6">
<meta name="description" content="Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ø¹Ø±Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„ Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ClainAI">

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" href="/static/icons/icon-152x152.png">


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClainAI - Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¨Ù„Øµ ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª */
        .plus-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            margin-left: 10px;
        }

        .plus-button:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .attachments-menu {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
            border: 1px solid #e2e8f0;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .attachment-item:hover {
            background: #f7fafc;
            transform: translateX(-5px);
        }

        .attachment-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .attachment-text {
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
        }

        .file-message {
            background: #f7fafc;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin-bottom: 8px;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-name {
            font-weight: 600;
            color: #2d3748;
        }

        .file-size {
            font-size: 12px;
            color: #a0aec0;
        }

        .location-message {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
        }

        .location-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .location-link:hover {
            text-decoration: underline;
        }

        .voice-message {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            flex: 1;
        }

        .voice-bar {
            width: 3px;
            background: #667eea;
            border-radius: 2px;
            animation: voicePulse 1.5s ease-in-out infinite;
        }

        .voice-bar:nth-child(2) { animation-delay: 0.2s; height: 12px; }
        .voice-bar:nth-child(3) { animation-delay: 0.4s; height: 18px; }
        .voice-bar:nth-child(4) { animation-delay: 0.6s; height: 14px; }
        .voice-bar:nth-child(5) { animation-delay: 0.8s; height: 10px; }

        @keyframes voicePulse {
            0%, 100% { height: 8px; }
            50% { height: 20px; }
        }

        .input-container {
            position: relative;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 480px) {
            .plus-button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .attachments-menu {
                bottom: 70px;
                right: 15px;
                min-width: 140px;
            }

            .attachment-item {
                padding: 10px 12px;
                gap: 10px;
            }

            .attachment-text {
                font-size: 13px;
            }
        }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
        }

        .notification-success { background: #48bb78; }
        .notification-error { background: #f56565; }
        .notification-info { background: #667eea; }

        .notification button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .thinking {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="header">
            <h1>ğŸ¤– ClainAI Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h1>
            <div class="subtitle">Ù…Ø­Ø§Ø¯Ø«Ø© Ø°ÙƒÙŠØ© Ù…Ø«Ù„ ChatGPT ØªÙ…Ø§Ù…Ø§Ù‹</div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
        <div class="user-info" id="userInfo">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>

        <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
        <div class="chat-container" id="chatContainer">
            <div class="thinking" id="thinking">ğŸš€ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="action-buttons">
            <button class="action-button clear" onclick="clearChat()">
                ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            </button>
            <button class="action-button logout" onclick="logout()">
                ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ù„Øµ -->
        <div class="input-container">
            <!-- Ø²Ø± Ø§Ù„Ø¨Ù„Øµ -->
            <button class="plus-button" id="plusButton">
                <span>+</span>
            </button>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
            <div class="attachments-menu" id="attachmentsMenu">
                <div class="attachment-item" onclick="attachFile('image')">
                    <span class="attachment-icon">ğŸ–¼ï¸</span>
                    <span class="attachment-text">ØµÙˆØ±Ø©</span>
                </div>
                <div class="attachment-item" onclick="attachFile('document')">
                    <span class="attachment-icon"> ğŸ“„</span>
                    <span class="attachment-text">Ù…Ù„Ù</span>
                </div>
                <div class="attachment-item" onclick="shareLocation()">
                    <span class="attachment-icon"> ğŸ“</span>
                    <span class="attachment-text">Ù…ÙˆÙ‚Ø¹</span>
                </div>
                <div class="attachment-item" onclick="showVoiceMessage()">
                    <span class="attachment-icon"> ğŸ¤</span>
                    <span class="attachment-text">Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</span>
                </div>
            </div>

            <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ -->
            <input type="text" class="message-input" id="messageInput"
                   placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">

            <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
            <button class="send-button" onclick="sendMessage()" id="sendButton">
                <span>Ø¥Ø±Ø³Ø§Ù„</span>
            </button>

            <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ÙÙŠ -->
            <input type="file" id="fileInput" style="display: none;"
                   accept=".png,.jpg,.jpeg,.gif,.pdf,.txt,.doc,.docx">
        </div>
    </div>

    <script>
        // Ù†Ø¸Ø§Ù… ClainAI Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
        class ClainAIChat {
            constructor() {
                this.currentSession = {
                    messages: [],
                    isLoading: false,
                    user: null,
                    typing: false
                };
                this.init();
            }

            // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
            async init() {
                console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© ClainAI...');
                await this.loadUserInfo();
                await this.loadChatHistory();
                this.setupEventListeners();
                this.initAttachments();
                this.showWelcomeMessage();
                console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© ClainAI Ø¨Ù†Ø¬Ø§Ø­!');
            }

            // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            async loadUserInfo() {
                try {
                    const response = await fetch('/api/user');
                    if (response.ok) {
                        const user = await response.json();
                        this.currentSession.user = user;
                        this.updateUIUserInfo(user);
                    } else {
                        this.setupGuestSession();
                    }
                } catch (error) {
                    console.log('Ø¬Ù„Ø³Ø© Ø¶ÙŠÙ:', error);
                    this.setupGuestSession();
                }
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ø© Ø¶ÙŠÙ
            setupGuestSession() {
                this.currentSession.user = {
                    name: 'Ø¶ÙŠÙ',
                    role: 'user',
                    email: 'guest@clainai.com'
                };
                this.updateUIUserInfo(this.currentSession.user);
            }

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            updateUIUserInfo(user) {
                const userInfoElement = document.getElementById('userInfo');
                if (userInfoElement) {
                    userInfoElement.innerHTML = `
                        <strong>ğŸ‘¤ ${user.name}</strong>
                        <span class="role-badge">${user.role}</span>
                        ${user.role === 'developer' ? 'ğŸ‘‘' : ''}
                    `;
                }
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');

                if (!messageInput) {
                    console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
                    return;
                }

                const message = messageInput.value.trim();

                if (!message || this.currentSession.isLoading) {
                    return;
                }

                // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                this.currentSession.isLoading = true;
                this.currentSession.typing = true;
                sendButton.disabled = true;
                messageInput.disabled = true;

                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
                this.addMessageToUI('user', message);
                messageInput.value = '';

                // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
                this.showTypingIndicator();

                try {
                    console.log('ğŸ”„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', message);

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message })
                    });

                    if (!response.ok) {
                        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø¯:', data);

                    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
                    this.hideTypingIndicator();

                    // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯
                    this.addMessageToUI('assistant', data.response || data.reply || data.answer);

                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', error);
                    this.hideTypingIndicator();
                    this.addMessageToUI('error', `âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}`);
                } finally {
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    this.currentSession.isLoading = false;
                    this.currentSession.typing = false;
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }

            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
            addMessageToUI(role, content) {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) {
                    console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
                    return;
                }

                const messageElement = document.createElement('div');
                messageElement.className = `message ${role}-message`;
                messageElement.setAttribute('role', 'listitem');

                // ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ„ Ø¯ÙˆØ±
                switch(role) {
                    case 'user':
                        messageElement.innerHTML = `
                            <div class="message-header">
                                <strong>ğŸ‘¤ Ø£Ù†Øª</strong>
                                <span class="message-time">${this.getCurrentTime()}</span>
                            </div>
                            <div class="message-content">${this.formatContent(content)}</div>
                        `;
                        break;

                    case 'assistant':
                        messageElement.innerHTML = `
                            <div class="message-header">
                                <strong>ğŸ¤– ClainAI</strong>
                                <span class="message-time">${this.getCurrentTime()}</span>
                            </div>
                            <div class="message-content">${this.formatContent(content)}</div>
                        `;
                        break;

                    case 'error':
                        messageElement.innerHTML = `
                            <div class="error-message">
                                <div class="message-header">
                                    <strong>âš ï¸ Ø®Ø·Ø£</strong>
                                    <span class="message-time">${this.getCurrentTime()}</span>
                                </div>
                                <div class="message-content">${this.formatContent(content)}</div>
                            </div>
                        `;
                        break;
                }

                chatContainer.appendChild(messageElement);

                // Scroll to bottom
                this.scrollToBottom();

                // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
                this.currentSession.messages.push({
                    role,
                    content,
                    timestamp: new Date()
                });
            }

            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            formatContent(content) {
                if (!content) return '';

                return content
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/~~(.*?)~~/g, '<del>$1</del>')
                    .replace(/_(.*?)_/g, '<u>$1</u>');
            }

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
            getCurrentTime() {
                return new Date().toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
            showTypingIndicator() {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) return;

                const typingElement = document.createElement('div');
                typingElement.id = 'typingIndicator';
                typingElement.className = 'message assistant-message';
                typingElement.innerHTML = `
                    <div class="message-header">
                        <strong>ğŸ¤– ClainAI</strong>
                        <span class="message-time">${this.getCurrentTime()}</span>
                    </div>
                    <div class="thinking-indicator">
                        <div class="thinking-dots">
                            <span>ÙŠÙƒØªØ¨</span>
                            <span class="dot">.</span>
                            <span class="dot">.</span>
                            <span class="dot">.</span>
                        </div>
                    </div>
                `;

                chatContainer.appendChild(typingElement);
                this.scrollToBottom();
            }

            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
            hideTypingIndicator() {
                const typingElement = document.getElementById('typingIndicator');
                if (typingElement) {
                    typingElement.remove();
                }
            }

            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
            scrollToBottom() {
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }

            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¶ØºØ· Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            handleKeyPress(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    this.sendMessage();
                }
            }

            // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            async loadChatHistory() {
                try {
                    const response = await fetch('/api/history');
                    if (response.ok) {
                        const history = await response.json();
                        const chatContainer = document.getElementById('chatContainer');

                        if (chatContainer && history.messages && history.messages.length > 0) {
                            chatContainer.innerHTML = '';
                            history.messages.forEach(msg => {
                                this.addMessageToUI(msg.role, msg.content);
                            });
                        }
                    }
                } catch (error) {
                    console.log('ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚');
                }
            }

            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
            showWelcomeMessage() {
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer && chatContainer.children.length === 0) {
                    setTimeout(() => {
                        this.addMessageToUI('assistant',
                            'ğŸ‰ **Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ClainAI!** ğŸŒŸ\n\n' +
                            'Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø°ÙŠ ÙŠØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£Ø³Ø¦Ù„ØªÙƒ Ø¨Ø¯Ù‚Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©.\n\n' +
                            '**ğŸ’« ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:**\n' +
                            'â€¢ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙƒ Ø§Ù„Ø¹Ù„Ù…ÙŠØ©  ğŸ§ª\n' +
                            'â€¢ Ø´Ø±Ø­ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„ØªÙ‚Ù†ÙŠØ© ğŸ’»\n' +
                            'â€¢ ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø«Ù‚Ø§ÙÙŠØ© ğŸŒ\n' +
                            'â€¢ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± ğŸ”§\n\n' +
                            '**ğŸ¯ Ø¬Ø±Ø¨ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:**\n' +
                            'â€¢ "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ?"\n' +
                            'â€¢ "Ø§Ø´Ø±Ø­ Ø§Ù„Ø­ÙˆØ³Ø¨Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©"\n' +
                            'â€¢ "ÙƒÙŠÙ Ø£ØªØ¹Ù„Ù… Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©?"\n\n' +
                            'Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡! ğŸ˜Š'
                        );
                    }, 500);
                }
            }

            // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            async clearChat() {
                if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.')) return;

                try {
                    const response = await fetch('/api/clear', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const chatContainer = document.getElementById('chatContainer');
                        if (chatContainer) {
                            chatContainer.innerHTML = '';
                            this.currentSession.messages = [];
                            this.showWelcomeMessage();
                        }
                        this.showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', error);
                    this.showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'error');
                }
            }

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            async logout() {
                try {
                    const response = await fetch('/api/logout');

                    if (response.ok) {
                        window.location.href = '/login';
                    } else {
                        // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù€ fetchØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø©
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:', error);
                    // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ ØªÙˆØ¬ÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ login
                    window.location.href = '/login';
                }
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            showNotification(message, type = 'info') {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()">âœ•</button>
                `;

                document.body.appendChild(notification);

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 3000);
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
            initAttachments() {
                const plusButton = document.getElementById('plusButton');
                const attachmentsMenu = document.getElementById('attachmentsMenu');
                const fileInput = document.getElementById('fileInput');

                if (plusButton && attachmentsMenu) {
                    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                    plusButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        attachmentsMenu.style.display = attachmentsMenu.style.display === 'flex' ? 'none' : 'flex';
                    });

                    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
                    document.addEventListener('click', function() {
                        attachmentsMenu.style.display = 'none';
                    });

                    // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¯Ø§Ø®Ù„Ù‡Ø§
                    attachmentsMenu.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }

                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ù…Ù„Ù Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                }
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            setupEventListeners() {
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');

                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => this.handleKeyPress(e));
                    messageInput.addEventListener('input', () => {
                        // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
                        sendButton.disabled = messageInput.value.trim() === '';
                    });
                }

                if (sendButton) {
                    sendButton.addEventListener('click', () => this.sendMessage());
                }

                // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ÙˆÙ‚Øª
                setInterval(() => {
                    this.updateMessageTimes();
                }, 60000); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
            }

            // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            updateMessageTimes() {
                const messageHeaders = document.querySelectorAll('.message-header .message-time');
                messageHeaders.forEach(header => {
                    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                });
            }
        }

        // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© =====

        // Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù
        function attachFile(type) {
            const fileInput = document.getElementById('fileInput');
            const attachmentsMenu = document.getElementById('attachmentsMenu');

            attachmentsMenu.style.display = 'none';

            if (type === 'image') {
                fileInput.accept = '.png,.jpg,.jpeg,.gif';
            } else {
                fileInput.accept = '.pdf,.txt,.doc,.docx';
            }

            fileInput.click();
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
            window.clainai.addMessageToUI('user', `
                <div class="file-message">
                    <div class="file-info">
                        <span class="file-icon">${file.type.startsWith('image/') ? 'ğŸ–¼ï¸' : 'ğŸ“„'}</span>
                        <span class="file-name">${file.name}</span>
                    </div>
                    <div class="file-size">(${(file.size / 1024).toFixed(1)} KB)</div>
                    <div class="upload-status">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</div>
                </div>
            `);

            // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
            uploadFile(file);
        }

        // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø³ÙŠØ±ÙØ±
        async function uploadFile(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹
                    const messages = document.querySelectorAll('.file-message');
                    const lastMessage = messages[messages.length - 1];
                    if (lastMessage) {
                        lastMessage.querySelector('.upload-status').textContent = 'âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­';
                    }

                    // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯
                    setTimeout(() => {
                        window.clainai.addMessageToUI('assistant',
                            `âœ… **ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ${file.type.startsWith('image/') ? 'Ø§Ù„ØµÙˆØ±Ø©' : 'Ø§Ù„Ù…Ù„Ù'} Ø¨Ù†Ø¬Ø§Ø­!**\n\n` +
                            `ğŸ“ **Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù:** ${file.name}\n` +
                            `ğŸ“Š **Ø§Ù„Ø­Ø¬Ù…:** ${(file.size / 1024).toFixed(1)} KB\n\n` +
                            `ğŸ’¡ *ÙŠÙ…ÙƒÙ†Ùƒ ÙˆØµÙ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù ÙˆØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ ØªØ­Ù„ÙŠÙ„Ù‡!*`
                        );
                    }, 1000);
                } else {
                    throw new Error(data.error || 'ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
                }
            } catch (error) {
                window.clainai.addMessageToUI('error', `âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ${error.message}`);
            }
        }

        // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹
        async function shareLocation() {
            const attachmentsMenu = document.getElementById('attachmentsMenu');
            attachmentsMenu.style.display = 'none';

            if (!navigator.geolocation) {
                window.clainai.addMessageToUI('error', 'âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹');
                return;
            }

            window.clainai.addMessageToUI('user', 'ğŸ“ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹...');

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        timeout: 10000,
                        enableHighAccuracy: true
                    });
                });

                const lat = position.coords.latitude.toFixed(6);
                const lng = position.coords.longitude.toFixed(6);

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø³ÙŠØ±ÙØ±
                const response = await fetch('/api/location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: lat,
                        lng: lng
                    })
                });

                if (response.ok) {
                    // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                    const messages = document.querySelectorAll('.message');
                    const lastUserMessage = Array.from(messages)
                        .reverse()
                        .find(msg => msg.classList.contains('user-message'));

                    if (lastUserMessage) {
                        lastUserMessage.innerHTML = `
                            <div class="location-message">
                                <div class="message-header">
                                    <strong>ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</strong>
                                    <span class="message-time">${new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})}</span>
                                </div>
                                <div class="message-content">
                                    <strong>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong> ${lat}, ${lng}<br>
                                    <a href="https://maps.google.com/?q=${lat},${lng}"
                                       target="_blank" class="location-link">
                                       ğŸ‘‰ Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„
                                    </a>
                                </div>
                            </div>
                        `;
                    }

                    // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯
                    setTimeout(() => {
                        window.clainai.addMessageToUI('assistant',
                            `**ğŸŒ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…ÙˆÙ‚Ø¹Ùƒ!**\n\n` +
                            `ğŸ“ **Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:** ${lat}, ${lng}\n\n` +
                            `ğŸ’« *ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:*\n` +
                            `â€¢ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©\n` +
                            `â€¢ Ø§Ù„Ø·Ù‚Ø³\n` +
                            `â€¢ Ø£Ù…Ø§ÙƒÙ† Ù‚Ø±ÙŠØ¨Ø©\n` +
                            `â€¢ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹*`
                        );
                    }, 1000);
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
                }
            } catch (error) {
                window.clainai.addMessageToUI('error', `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${error.message}`);
            }
        }

        // Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© (Ù…Ø­Ø§ÙƒØ§Ø©)
        function showVoiceMessage() {
            const attachmentsMenu = document.getElementById('attachmentsMenu');
            attachmentsMenu.style.display = 'none';

            window.clainai.addMessageToUI('user', `
                <div class="voice-message">
                    <span class="attachment-icon"> ğŸ¤</span>
                    <div class="voice-wave">
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                    </div>
                    <span>Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© (5 Ø«ÙˆØ§Ù†ÙŠ)</span>
                </div>
            `);

            // Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙˆØªÙŠØ©
            setTimeout(() => {
                window.clainai.addMessageToUI('assistant',
                    'ğŸ¤ **ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„ØªÙƒ Ø§Ù„ØµÙˆØªÙŠØ©!**\n\n' +
                    'ğŸ’¡ *Ø­Ø§Ù„ÙŠØ§Ù‹ Ø£Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù†ØµÙŠØ©ØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ù…Ø§ ØªØ±ÙŠØ¯ Ù‚ÙˆÙ„Ù‡ ÙˆØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ!*'
                );
            }, 2000);
        }

        // ===== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ø¯Ù…Ø¬ =====

        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            window.clainai = new ClainAIChat();
        });

        // Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        window.addEventListener('error', function(event) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…:', event.error);
        });

        // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
        window.sendMessage = function() { window.clainai?.sendMessage(); }
        window.clearChat = function() { window.clainai?.clearChat(); }
        window.logout = function() { window.clainai?.logout(); }
        window.handleKeyPress = function(event) { window.clainai?.handleKeyPress(event); }
    </script>
<script>
// PWA Installation
let deferredPrompt;
const installBtn = document.createElement('button');

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    // Ø£Ø¸Ù‡Ø± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª
    installBtn.style.display = 'block';
    installBtn.textContent = 'ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚';
    installBtn.className = 'install-btn';
    installBtn.style.position = 'fixed';
    installBtn.style.bottom = '20px';
    installBtn.style.left = '20px';
    installBtn.style.background = '#3B82F6';
    installBtn.style.color = 'white';
    installBtn.style.border = 'none';
    installBtn.style.padding = '12px 20px';
    installBtn.style.borderRadius = '25px';
    installBtn.style.cursor = 'pointer';
    installBtn.style.fontSize = '14px';
    installBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
    installBtn.style.zIndex = '1000';
    installBtn.style.display = 'none';

    document.body.appendChild(installBtn);
});

installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            installBtn.style.display = 'none';
            console.log('User accepted the install prompt');
        }
        deferredPrompt = null;
    }
});

// ØªØ³Ø¬ÙŠÙ„ Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
            .then(function(registration) {
                console.log('ServiceWorker registered: ', registration);
            })
            .catch(function(error) {
                console.log('ServiceWorker registration failed: ', error);
            });
    });
}
</script>

</body>
</html>
